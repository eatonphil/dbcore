project: todo

database:
  dialect: sqlite
  database: todo.db

api:
  routerPrefix: v1/
  auth:
    enabled: true
    allow:
      notes:
        # Must be public or tied to the current user's organization.
        get: |
          is_public OR
          organization IN (
            SELECT id
            FROM organizations o
            JOIN users u ON u.organization = o.id
            WHERE u.id = $req_user_id
          )
        # Must be created by the user or tied to the current user's organization and an admin.
        put: &ownedOrOrgAdmin |
          created_by = $req_user_id OR
          organization IN (
            SELECT id
            FROM organizations o
            JOIN users u ON u.organization = o.id
            WHERE u.id = $req_user_id AND u.is_admin
          )
        # Same as edit (put)
        delete: *ownedOrOrgAdmin
        # Must be in the same org
        post: |
          organization IN (
            SELECT id
            FROM organizations o
            JOIN users u ON u.organization = o.id
            WHERE u.id = $req_user_id
          )
      users:
        # Must be in the same org
        get: &inOrg |
          organization IN (
            SELECT id
            FROM organizations o
            JOIN users u ON u.organization = o.id
            WHERE u.id = $req_user_id
          )
        put: *inOrg
        delete: &inOrgandIsadmin |
          created_by = $req_user_id OR
          organization IN (
            SELECT id
            FROM organizations o
            JOIN users u ON organization = o.id
            WHERE u.id = $req_user_id AND u.is_admin
          )
        post: *inOrgandIsadmin
      organizations:
        get: |
          id IN (
            SELECT o.id
            FROM organizations o
            JOIN users u ON u.organization = o.id
            WHERE u.id = $req_user_id
          )
        put: &inOrgAndIsAdmin |
          id IN (
            SELECT o.id
            FROM organizations o
            JOIN users u ON u.organization = o.id
            WHERE u.id = $req_user_id AND u.is_admin
          )
        delete: *inOrgandIsadmin
  audit:
    enabled: true
    createdAt: created_at
    updatedAt: updated_at
    deletedAt: deleted_at
  extra:
    repo: github.com/eatonphil/dbcore-todo

browser: {}
